var ft=Object.defineProperty,ut=Object.defineProperties;var dt=Object.getOwnPropertyDescriptors;var oe=Object.getOwnPropertySymbols;var Fe=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable;var Ne=s=>{throw TypeError(s)};var Le=(s,e,t)=>e in s?ft(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,R=(s,e)=>{for(var t in e||(e={}))Fe.call(e,t)&&Le(s,t,e[t]);if(oe)for(var t of oe(e))Ie.call(e,t)&&Le(s,t,e[t]);return s},J=(s,e)=>ut(s,dt(e));var Ve=(s,e)=>{var t={};for(var r in s)Fe.call(s,r)&&e.indexOf(r)<0&&(t[r]=s[r]);if(s!=null&&oe)for(var r of oe(s))e.indexOf(r)<0&&Ie.call(s,r)&&(t[r]=s[r]);return t};var Se=(s,e,t)=>e.has(s)||Ne("Cannot "+t);var n=(s,e,t)=>(Se(s,e,"read from private field"),t?t.call(s):e.get(s)),u=(s,e,t)=>e.has(s)?Ne("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),c=(s,e,t,r)=>(Se(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),m=(s,e,t)=>(Se(s,e,"access private method"),t);var E=(s,e,t)=>new Promise((r,i)=>{var o=d=>{try{l(t.next(d))}catch(h){i(h)}},a=d=>{try{l(t.throw(d))}catch(h){i(h)}},l=d=>d.done?r(d.value):Promise.resolve(d.value).then(o,a);l((t=t.apply(s,e)).next())});var A=class s extends Error{constructor(t,r,i,o,a,l){super(l||`HTTP Error ${t} at ${a}: ${r!=null?r:JSON.stringify(i)}`);this.url=a;this.name="FetchError",this.status=t,this.text=r,this.json=i,this.headers=o}static fromResponse(t,r){return E(this,null,function*(){let i=t.status,o=Object.fromEntries([...t.headers.entries()]),a,l,d=t.headers.get("content-type");return d&&d.includes("application/json")?l=yield t.json():a=yield t.text(),new s(i,a,l,o,r)})}},N=class extends Error{constructor(){super("Fetch with backoff aborted"),this.name="FetchBackoffAbortError"}};var ce=class extends Error{constructor(){super("Invalid shape options: missing required url parameter"),this.name="MissingShapeUrlError"}},le=class extends Error{constructor(){super("Invalid signal option. It must be an instance of AbortSignal."),this.name="InvalidSignalError"}},he=class extends Error{constructor(){super("shapeHandle is required if this isn't an initial fetch (i.e. offset > -1)"),this.name="MissingShapeHandleError"}},fe=class extends Error{constructor(e){super(`Cannot use reserved Electric parameter names in custom params: ${e.join(", ")}`),this.name="ReservedParamError"}},ue=class extends Error{constructor(e){super(`Column "${e!=null?e:"unknown"}" does not allow NULL values`),this.name="ParserNullValueError"}};var de=class extends Error{constructor(e,t){let r=`The response for the shape request to ${e} didn't include the following required headers:
`;t.forEach(i=>{r+=`- ${i}
`}),r+=`
This is often due to a proxy not setting CORS correctly so that all Electric headers can be read by the client.`,r+=`
For more information visit the troubleshooting guide: /docs/guides/troubleshooting/missing-headers`,super(r)}};var pe=s=>Number(s),pt=s=>s==="true"||s==="t",mt=s=>BigInt(s),je=s=>JSON.parse(s),Et=s=>s,gt={int2:pe,int4:pe,int8:mt,bool:pt,float4:pe,float8:pe,json:je,jsonb:je};function bt(s,e){let t=0,r=null,i="",o=!1,a=0,l;function d(h){let f=[];for(;t<h.length;t++){if(r=h[t],o)r==="\\"?i+=h[++t]:r==='"'?(f.push(e?e(i):i),i="",o=h[t+1]==='"',a=t+2):i+=r;else if(r==='"')o=!0;else if(r==="{")a=++t,f.push(d(h));else if(r==="}"){o=!1,a<t&&f.push(e?e(h.slice(a,t)):h.slice(a,t)),a=t+1;break}else r===","&&l!=="}"&&l!=='"'&&(f.push(e?e(h.slice(a,t)):h.slice(a,t)),a=t+1);l=r}return a<t&&f.push(e?e(h.slice(a,t+1)):h.slice(a,t+1)),f}return d(s)[0]}var me=class{constructor(e){this.parser=R(R({},gt),e)}parse(e,t){return JSON.parse(e,(r,i)=>{if((r==="value"||r==="old_value")&&typeof i=="object"&&i!==null){let o=i;Object.keys(o).forEach(a=>{o[a]=this.parseRow(a,o[a],t)})}return i})}parseRow(e,t,r){var S;let i=r[e];if(!i)return t;let f=i,{type:o,dims:a}=f,l=Ve(f,["type","dims"]),d=(S=this.parser[o])!=null?S:Et,h=Be(d,i,e);return a&&a>0?Be((g,z)=>bt(g,h),i,e)(t):h(t,l)}};function Be(s,e,t){var i;let r=!((i=e.not_null)!=null&&i);return o=>{if(Rt(o)){if(!r)throw new ue(t!=null?t:"unknown");return null}return s(o,e)}}function Rt(s){return s===null||s==="NULL"}function Ee(s){return"key"in s}function ge(s){return!Ee(s)}function qe(s){return ge(s)&&s.headers.control==="up-to-date"}var Ye="electric-cursor",X="electric-handle",be="electric-offset",Qe="electric-schema",Ke="electric-up-to-date",We="columns",we="cursor",Z="handle",M="live",ee="offset",$e="table",Ge="where",ze="replica",Je="params",xe="force-disconnect-and-refresh";var Pt=[429],Pe={initialDelay:100,maxDelay:1e4,multiplier:1.3};function Xe(s,e=Pe){let{initialDelay:t,maxDelay:r,multiplier:i,debug:o=!1,onFailedAttempt:a}=e;return(...l)=>E(this,null,function*(){var I;let d=l[0],h=l[1],f=t,S=0;for(;;)try{let g=yield s(...l);if(g.ok)return g;throw yield A.fromResponse(g,d.toString())}catch(g){if(a==null||a(),(I=h==null?void 0:h.signal)!=null&&I.aborted)throw new N;if(g instanceof A&&!Pt.includes(g.status)&&g.status>=400&&g.status<500)throw g;yield new Promise(z=>setTimeout(z,f)),f=Math.min(f*i,r),o&&(S++,console.log(`Retry attempt #${S} after ${f}ms`))}})}var yt={maxChunksToPrefetch:2};function Ze(s,e=yt){let{maxChunksToPrefetch:t}=e,r;return(...o)=>E(this,null,function*(){let a=o[0].toString(),l=r==null?void 0:r.consume(...o);if(l)return l;r==null||r.abort();let d=yield s(...o),h=_e(a,d);return h&&(r=new Te({fetchClient:s,maxPrefetchedRequests:t,url:h,requestInit:o[1]})),d})}var At=["electric-offset","electric-handle"],St=["electric-cursor"],wt=["electric-schema"];function et(s){return(...e)=>E(this,null,function*(){let t=yield s(...e);if(t.ok){let r=t.headers,i=[],o=h=>i.push(...h.filter(f=>!r.has(f)));o(At);let l=e[0].toString(),d=new URL(l);if(d.searchParams.get(M)==="true"&&o(St),(!d.searchParams.has(M)||d.searchParams.get(M)==="false")&&o(wt),i.length>0)throw new de(l,i)}return t})}var te,se,x,V,T,q,Re,Te=class{constructor(e){u(this,q);u(this,te);u(this,se);u(this,x,new Map);u(this,V);u(this,T);var t;c(this,te,(t=e.fetchClient)!=null?t:(...r)=>fetch(...r)),c(this,se,e.maxPrefetchedRequests),c(this,V,e.url.toString()),c(this,T,n(this,V)),m(this,q,Re).call(this,e.url,e.requestInit)}abort(){n(this,x).forEach(([e,t])=>t.abort())}consume(...e){var i;let t=e[0].toString(),r=(i=n(this,x).get(t))==null?void 0:i[0];if(!(!r||t!==n(this,V)))return n(this,x).delete(t),r.then(o=>{let a=_e(t,o);c(this,V,a),n(this,T)&&!n(this,x).has(n(this,T))&&m(this,q,Re).call(this,n(this,T),e[1])}).catch(()=>{}),r}};te=new WeakMap,se=new WeakMap,x=new WeakMap,V=new WeakMap,T=new WeakMap,q=new WeakSet,Re=function(...e){var i,o;let t=e[0].toString();if(n(this,x).size>=n(this,se))return;let r=new AbortController;try{let{signal:a,cleanup:l}=xt(r,(i=e[1])==null?void 0:i.signal),d=n(this,te).call(this,t,J(R({},(o=e[1])!=null?o:{}),{signal:a}));n(this,x).set(t,[d,r]),d.then(h=>{if(!h.ok||r.signal.aborted)return;let f=_e(t,h);if(!f||f===t){c(this,T,void 0);return}return c(this,T,f),m(this,q,Re).call(this,f,e[1])}).catch(()=>{}).finally(l)}catch(a){}};function _e(s,e){let t=e.headers.get(X),r=e.headers.get(be),i=e.headers.has(Ke);if(!t||!r||i)return;let o=new URL(s);if(!o.searchParams.has(M))return o.searchParams.set(Z,t),o.searchParams.set(ee,r),o.searchParams.sort(),o.toString()}function xt(s,e){let t=Tt;if(e)if(e.aborted)s.abort();else{let r=()=>s.abort();e.addEventListener("abort",r,{once:!0,signal:s.signal}),t=()=>e.removeEventListener("abort",r)}return{signal:s.signal,cleanup:t}}function Tt(){}var _t=new Set([we,Z,M,ee]);function tt(s){return E(this,null,function*(){return typeof s=="function"?s():s})}function Ct(s){return E(this,null,function*(){let e=Object.entries(s),t=yield Promise.all(e.map(o=>E(this,[o],function*([r,i]){if(i===void 0)return[r,void 0];let a=yield tt(i);return[r,Array.isArray(a)?a.join(","):a]})));return Object.fromEntries(t.filter(([r,i])=>i!==void 0))})}function kt(s){return E(this,null,function*(){if(!s)return{};let e=Object.entries(s),t=yield Promise.all(e.map(o=>E(this,[o],function*([r,i]){return[r,yield tt(i)]})));return Object.fromEntries(t)})}var re,ne,ie,H,v,O,j,U,w,D,_,B,Q,y,K,C,W,$,b,ke,st,Me,rt,He,Ce=class{constructor(e){u(this,b);u(this,re,null);u(this,ne);u(this,ie);u(this,H,new Map);u(this,v,!1);u(this,O);u(this,j);u(this,U);u(this,w,!1);u(this,D,!1);u(this,_);u(this,B);u(this,Q);u(this,y);u(this,K,!1);u(this,C);u(this,W);u(this,$);var i,o,a;this.options=R({subscribe:!0},e),Mt(this.options),c(this,O,(i=this.options.offset)!=null?i:"-1"),c(this,j,""),c(this,_,this.options.handle),c(this,ie,new me(e.parser)),c(this,Q,this.options.onError);let t=(o=e.fetchClient)!=null?o:(...l)=>fetch(...l),r=Xe(t,J(R({},(a=e.backoffOptions)!=null?a:Pe),{onFailedAttempt:()=>{var l,d;c(this,D,!1),(d=(l=e.backoffOptions)==null?void 0:l.onFailedAttempt)==null||d.call(l)}}));c(this,ne,et(Ze(r)))}get shapeHandle(){return n(this,_)}get error(){return n(this,re)}get isUpToDate(){return n(this,w)}get lastOffset(){return n(this,O)}subscribe(e,t=()=>{}){let r=Math.random();return n(this,H).set(r,[e,t]),n(this,v)||m(this,b,ke).call(this),()=>{n(this,H).delete(r)}}unsubscribeAll(){n(this,H).clear()}lastSyncedAt(){return n(this,U)}lastSynced(){return n(this,U)===void 0?1/0:Date.now()-n(this,U)}isConnected(){return n(this,D)}isLoading(){return!n(this,w)}hasStarted(){return n(this,v)}forceDisconnectAndRefresh(){return E(this,null,function*(){var e,t;c(this,K,!0),n(this,w)&&!((e=n(this,y))!=null&&e.signal.aborted)&&((t=n(this,y))==null||t.abort(xe)),yield m(this,b,st).call(this),c(this,K,!1)})}};re=new WeakMap,ne=new WeakMap,ie=new WeakMap,H=new WeakMap,v=new WeakMap,O=new WeakMap,j=new WeakMap,U=new WeakMap,w=new WeakMap,D=new WeakMap,_=new WeakMap,B=new WeakMap,Q=new WeakMap,y=new WeakMap,K=new WeakMap,C=new WeakMap,W=new WeakMap,$=new WeakMap,b=new WeakSet,ke=function(){return E(this,null,function*(){var e,t,r,i,o;if(n(this,v))throw new Error("Cannot start stream twice");c(this,v,!0);try{for(;!((e=this.options.signal)!=null&&e.aborted)&&!n(this,w)||this.options.subscribe;){let{url:a,signal:l}=this.options,[d,h]=yield Promise.all([kt(this.options.headers),this.options.params?Ct(Ht(this.options.params)):void 0]);h&&nt(h);let f=new URL(a);if(h){h.table&&Y(f,$e,h.table),h.where&&Y(f,Ge,h.where),h.columns&&Y(f,We,h.columns),h.replica&&Y(f,ze,h.replica),h.params&&Y(f,Je,h.params);let p=R({},h);delete p.table,delete p.where,delete p.columns,delete p.replica,delete p.params;for(let[Ae,ht]of Object.entries(p))Y(f,Ae,ht)}f.searchParams.set(ee,n(this,O)),n(this,w)&&(n(this,K)||f.searchParams.set(M,"true"),f.searchParams.set(we,n(this,j))),n(this,_)&&f.searchParams.set(Z,n(this,_)),f.searchParams.sort(),c(this,y,new AbortController);let S;l&&(S=()=>{var p;(p=n(this,y))==null||p.abort(l.reason)},l.addEventListener("abort",S,{once:!0}),l.aborted&&((t=n(this,y))==null||t.abort(l.reason)));let I;try{I=yield n(this,ne).call(this,f.toString(),{signal:n(this,y).signal,headers:d}),c(this,D,!0)}catch(p){if((p instanceof A||p instanceof N)&&n(this,y).signal.aborted&&n(this,y).signal.reason===xe)continue;if(p instanceof N)break;if(!(p instanceof A))throw p;if(p.status==409){let Ae=p.headers[X];m(this,b,He).call(this,Ae),yield m(this,b,Me).call(this,p.json);continue}else if(p.status>=400&&p.status<500)throw m(this,b,rt).call(this,p),p}finally{S&&l&&l.removeEventListener("abort",S),c(this,y,void 0)}let{headers:g,status:z}=I,Oe=g.get(X);Oe&&c(this,_,Oe);let Ue=g.get(be);Ue&&c(this,O,Ue);let De=g.get(Ye);De&&c(this,j,De);let ct=()=>{let p=g.get(Qe);return p?JSON.parse(p):{}};c(this,B,(r=n(this,B))!=null?r:ct());let lt=z===204?"[]":yield I.text();z===204&&c(this,U,Date.now());let ae=n(this,ie).parse(lt,n(this,B));if(ae.length>0){let p=ae[ae.length-1];qe(p)&&(c(this,U,Date.now()),c(this,w,!0)),yield m(this,b,Me).call(this,ae)}(i=n(this,W))==null||i.call(this)}}catch(a){if(c(this,re,a),n(this,Q)){let l=yield n(this,Q).call(this,a);typeof l=="object"&&(m(this,b,He).call(this),"params"in l&&(this.options.params=l.params),"headers"in l&&(this.options.headers=l.headers),c(this,v,!1),m(this,b,ke).call(this));return}throw a}finally{c(this,D,!1),(o=n(this,$))==null||o.call(this)}})},st=function(){return E(this,null,function*(){return n(this,C)?n(this,C):(c(this,C,new Promise((e,t)=>{c(this,W,e),c(this,$,t)})),n(this,C).finally(()=>{c(this,C,void 0),c(this,W,void 0),c(this,$,void 0)}),n(this,C))})},Me=function(e){return E(this,null,function*(){yield Promise.all(Array.from(n(this,H).values()).map(i=>E(this,[i],function*([t,r]){try{yield t(e)}catch(o){queueMicrotask(()=>{throw o})}})))})},rt=function(e){n(this,H).forEach(([t,r])=>{r==null||r(e)})},He=function(e){c(this,O,"-1"),c(this,j,""),c(this,_,e),c(this,w,!1),c(this,D,!1),c(this,B,void 0)},Ce.Replica={FULL:"full",DEFAULT:"default"};function nt(s){if(!s)return;let e=Object.keys(s).filter(t=>_t.has(t));if(e.length>0)throw new fe(e)}function Mt(s){if(!s.url)throw new ce;if(s.signal&&!(s.signal instanceof AbortSignal))throw new le;if(s.offset!==void 0&&s.offset!=="-1"&&!s.handle)throw new he;nt(s.params)}function Y(s,e,t){if(!(t===void 0||t==null))if(typeof t=="string")s.searchParams.set(e,t);else if(typeof t=="object")for(let[r,i]of Object.entries(t))s.searchParams.set(`${e}[${r}]`,i);else s.searchParams.set(e,t.toString())}function Ht(s){return Array.isArray(s.params)?J(R({},s),{params:Object.fromEntries(s.params.map((e,t)=>[t+1,e]))}):s}var k,L,G,F,P,at,ye,ot,ve,it=class{constructor(e){u(this,P);u(this,k,new Map);u(this,L,new Map);u(this,G,"syncing");u(this,F,!1);this.stream=e,this.stream.subscribe(m(this,P,at).bind(this),m(this,P,ot).bind(this))}get isUpToDate(){return n(this,G)==="up-to-date"}get lastOffset(){return this.stream.lastOffset}get handle(){return this.stream.shapeHandle}get rows(){return this.value.then(e=>Array.from(e.values()))}get currentRows(){return Array.from(this.currentValue.values())}get value(){return new Promise((e,t)=>{if(this.stream.isUpToDate)e(this.currentValue);else{let r=this.subscribe(({value:i})=>{r(),n(this,F)&&t(n(this,F)),e(i)})}})}get currentValue(){return n(this,k)}get error(){return n(this,F)}lastSyncedAt(){return this.stream.lastSyncedAt()}lastSynced(){return this.stream.lastSynced()}isLoading(){return this.stream.isLoading()}isConnected(){return this.stream.isConnected()}subscribe(e){let t=Math.random();return n(this,L).set(t,e),()=>{n(this,L).delete(t)}}unsubscribeAll(){n(this,L).clear()}get numSubscribers(){return n(this,L).size}};k=new WeakMap,L=new WeakMap,G=new WeakMap,F=new WeakMap,P=new WeakSet,at=function(e){let t=!1;e.forEach(r=>{if(Ee(r))switch(t=m(this,P,ye).call(this,"syncing"),r.headers.operation){case"insert":n(this,k).set(r.key,r.value);break;case"update":n(this,k).set(r.key,R(R({},n(this,k).get(r.key)),r.value));break;case"delete":n(this,k).delete(r.key);break}if(ge(r))switch(r.headers.control){case"up-to-date":t=m(this,P,ye).call(this,"up-to-date");break;case"must-refetch":n(this,k).clear(),c(this,F,!1),t=m(this,P,ye).call(this,"syncing");break}}),t&&m(this,P,ve).call(this)},ye=function(e){let t=n(this,G)!==e;return c(this,G,e),t&&e==="up-to-date"},ot=function(e){e instanceof A&&(c(this,F,e),m(this,P,ve).call(this))},ve=function(){n(this,L).forEach(e=>{e({value:this.currentValue,rows:this.currentRows})})};export{Pe as BackoffDefaults,A as FetchError,it as Shape,Ce as ShapeStream,Ee as isChangeMessage,ge as isControlMessage,tt as resolveValue};
//# sourceMappingURL=index.browser.mjs.map