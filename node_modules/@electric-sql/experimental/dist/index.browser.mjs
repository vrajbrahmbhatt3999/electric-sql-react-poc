var X=Object.defineProperty,Y=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols,ee=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,ne=Reflect.get;var B=t=>{throw TypeError(t)};var D=(t,e,s)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,K=(t,e)=>{for(var s in e||(e={}))se.call(e,s)&&D(t,s,e[s]);if(L)for(var s of L(e))te.call(e,s)&&D(t,s,e[s]);return t},E=(t,e)=>Y(t,Z(e));var v=(t,e,s)=>e.has(t)||B("Cannot "+s);var a=(t,e,s)=>(v(t,e,"read from private field"),s?s.call(t):e.get(t)),g=(t,e,s)=>e.has(t)?B("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),S=(t,e,s,n)=>(v(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),u=(t,e,s)=>(v(t,e,"access private method"),s);var P=(t,e,s)=>ne(ee(t),s,e);var y=(t,e,s)=>new Promise((n,r)=>{var h=p=>{try{i(s.next(p))}catch(l){r(l)}},o=p=>{try{i(s.throw(p))}catch(l){r(l)}},i=p=>p.done?n(p.value):Promise.resolve(p.value).then(h,o);i((s=s.apply(t,e)).next())});import{isChangeMessage as ae}from"@electric-sql/client";function re(t,e,s,n=6e4){return new Promise((r,h)=>{let o=t.subscribe(l=>{let C=l.filter(b=>ae(b)).find(b=>{let W=b.headers.operation;return e.includes(W)&&s(b)});if(C)return p(C)}),i=setTimeout(()=>{let l=`matchStream timed out after ${n}ms`;console.error(l),h(l)},n);function p(l){return clearTimeout(i),o(),r(l)}})}function he(t,e){return s=>s.value[t]===e}function R(...t){return BigInt(t.reduce((e,s)=>s>e?s:e))}function j(...t){return BigInt(t.reduce((e,s)=>s<e?s:e))}function F(t,e){return t>e?1:t<e?-1:0}import{ShapeStream as N,isChangeMessage as G,isControlMessage as H}from"@electric-sql/client";var k,x,I,M,T,d,c,O,V,$,J,w,A=class{constructor(e){g(this,c);g(this,k);g(this,x,!1);g(this,I);g(this,M);g(this,T);g(this,d,new Map);let{start:s=!0,checkForUpdatesAfterMs:n=100,shapes:r}=e;this.checkForUpdatesAfterMs=n,S(this,k,Object.fromEntries(Object.entries(r).map(([h,o])=>[h,o instanceof N?o:new N(E(K({},o),{start:!1}))]))),S(this,M,Object.fromEntries(Object.entries(r).map(([h])=>[h,BigInt(-1)]))),S(this,T,Object.fromEntries(Object.entries(r).map(([h])=>[h,BigInt(-1)]))),s&&u(this,c,O).call(this)}_publish(e){return y(this,null,function*(){yield Promise.all(Array.from(a(this,d).values()).map(r=>y(this,[r],function*([s,n]){try{yield s(e)}catch(h){queueMicrotask(()=>{throw h})}})))})}get shapes(){return a(this,k)}subscribe(e,s){let n=Math.random();return a(this,d).set(n,[e,s]),a(this,x)||u(this,c,O).call(this),()=>{a(this,d).delete(n)}}unsubscribeAll(){a(this,d).clear()}lastSyncedAt(){return Math.min(...u(this,c,w).call(this).map(([e,s])=>{var n;return(n=s.lastSyncedAt())!=null?n:1/0}))}lastSynced(){let e=this.lastSyncedAt();return e===void 0?1/0:Date.now()-e}isConnected(){return u(this,c,w).call(this).every(([e,s])=>s.isConnected())}isLoading(){return u(this,c,w).call(this).some(([e,s])=>s.isLoading())}get isUpToDate(){return u(this,c,w).call(this).every(([e,s])=>s.isUpToDate)}};k=new WeakMap,x=new WeakMap,I=new WeakMap,M=new WeakMap,T=new WeakMap,d=new WeakMap,c=new WeakSet,O=function(){if(a(this,x))throw new Error("Cannot start multi-shape stream twice");for(let[e,s]of u(this,c,w).call(this)){if(s.hasStarted())throw new Error(`Shape ${e} already started`);s.subscribe(n=>y(this,null,function*(){let r=n.filter(H).map(({headers:i})=>typeof i.global_last_seen_lsn=="string"?BigInt(i.global_last_seen_lsn):BigInt(0));if(r.length>0){let i=R(...r),p=a(this,T)[e];i>p&&(a(this,T)[e]=i)}let h=n.filter(G).map(({headers:i})=>typeof i.lsn=="string"?BigInt(i.lsn):BigInt(0));if(h.length>0){let i=R(...h),p=a(this,M)[e];i>p&&(a(this,M)[e]=i),u(this,c,V).call(this)}let o=n.map(i=>E(K({},i),{shape:e}));yield this._publish(o)}),n=>u(this,c,J).call(this,n))}S(this,x,!0)},V=function(){var e;(e=a(this,I))!=null||S(this,I,setTimeout(()=>{u(this,c,$).call(this),S(this,I,void 0)},this.checkForUpdatesAfterMs))},$=function(){return y(this,null,function*(){let e=R(...Object.values(a(this,M))),s=u(this,c,w).call(this).filter(([n])=>a(this,T)[n]<e).map(([n,r])=>r.forceDisconnectAndRefresh());yield Promise.all(s)})},J=function(e){a(this,d).forEach(([s,n])=>{n==null||n(e)})},w=function(){return Object.entries(a(this,k))};var f,m,_,z,Q,U=class U extends A{constructor(s){super(s);g(this,_);g(this,f,new Map);g(this,m);S(this,m,Object.fromEntries(Object.entries(s.shapes).map(([n])=>[n,BigInt(-1)])))}_publish(s){return y(this,null,function*(){u(this,_,Q).call(this,s);let n=u(this,_,z).call(this),r=[...a(this,f).keys()].filter(o=>o<=n),h=r.sort((o,i)=>F(o,i)).map(o=>{var i;return(i=a(this,f).get(o))==null?void 0:i.sort((p,l)=>{let{headers:C}=p,{headers:b}=l;return typeof C.op_position!="number"||typeof b.op_position!="number"?0:C.op_position-b.op_position})}).filter(o=>o!==void 0).flat();r.forEach(o=>{a(this,f).delete(o)}),h.length>0&&(yield P(U.prototype,this,"_publish").call(this,h))})}};f=new WeakMap,m=new WeakMap,_=new WeakSet,z=function(){return j(...Object.values(a(this,m)))},Q=function(s){let n=this.isUpToDate;s.forEach(r=>{var i;let{shape:h,headers:o}=r;if(G(r)){let p=typeof o.lsn=="string"?BigInt(o.lsn):BigInt(0);a(this,f).has(p)||a(this,f).set(p,[]),(i=a(this,f).get(p))==null||i.push(r),n&&typeof o.last=="boolean"&&o.last===!0&&(a(this,m)[h]=R(a(this,m)[h],p))}else if(H(r)&&o.control==="up-to-date"){if(typeof o.global_last_seen_lsn!="string")throw new Error("global_last_seen_lsn is not a number");a(this,m)[h]=R(a(this,m)[h],BigInt(o.global_last_seen_lsn))}})};var q=U;export{A as MultiShapeStream,q as TransactionalMultiShapeStream,he as matchBy,re as matchStream};
//# sourceMappingURL=index.browser.mjs.map