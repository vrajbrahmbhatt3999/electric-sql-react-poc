{"version":3,"sources":["../../../src/drivers/op-sqlite/adapter.ts"],"sourcesContent":["import { Row, SqlValue } from '../../util/types'\nimport { BatchDatabaseAdapter as GenericDatabaseAdapter } from '../generic'\nimport { Statement } from '../../util'\nimport { Database } from './database'\nimport { RunResult } from '../../electric/adapter'\nimport { SQLBatchTuple } from '@op-engineering/op-sqlite'\n\nexport class DatabaseAdapter extends GenericDatabaseAdapter {\n  readonly db: Database\n  readonly defaultNamespace = 'main'\n\n  constructor(db: Database) {\n    super()\n    this.db = db\n  }\n\n  async _query(statement: Statement): Promise<Row[]> {\n    const result = await this.db.executeAsync(statement.sql, statement.args)\n\n    // the results returned are HostObjects and not regular JS objects and\n    // do not work in the same way - we shallow clone them to a regular JS\n    // object as the code makes use of Object APIs like Object.entries to\n    // work properly. See:\n    // https://ospfranco.notion.site/Gotchas-bedf4f3e9dc1444480fc687d8917751a\n    // https://github.com/OP-Engineering/op-sqlite/issues/65\n    return result.rows!._array.map(shallowClone)\n  }\n  async _run(statement: Statement): Promise<RunResult> {\n    const result = await this.db.executeAsync(statement.sql, statement.args)\n    return { rowsAffected: result.rowsAffected! }\n  }\n\n  async execBatch(statements: Statement[]): Promise<RunResult> {\n    const set: SQLBatchTuple[] = statements.map(({ sql, args }) => [\n      sql,\n      (args ?? []) as SqlValue[],\n    ])\n\n    const result = await this.db.executeBatchAsync(set)\n\n    return { rowsAffected: result.rowsAffected! }\n  }\n}\n\nfunction shallowClone(obj: Record<string, any>) {\n  const clonedObj: Record<string, any> = {}\n  for (const key in obj) {\n    clonedObj[key] = obj[key]\n  }\n  return clonedObj\n}\n"],"mappings":"AACA,SAAS,wBAAwB,8BAA8B;AAMxD,MAAM,wBAAwB,uBAAuB;AAAA,EACjD;AAAA,EACA,mBAAmB;AAAA,EAE5B,YAAY,IAAc;AACxB,UAAM;AACN,SAAK,KAAK;AAAA,EACZ;AAAA,EAEA,MAAM,OAAO,WAAsC;AACjD,UAAM,SAAS,MAAM,KAAK,GAAG,aAAa,UAAU,KAAK,UAAU,IAAI;AAQvE,WAAO,OAAO,KAAM,OAAO,IAAI,YAAY;AAAA,EAC7C;AAAA,EACA,MAAM,KAAK,WAA0C;AACnD,UAAM,SAAS,MAAM,KAAK,GAAG,aAAa,UAAU,KAAK,UAAU,IAAI;AACvE,WAAO,EAAE,cAAc,OAAO,aAAc;AAAA,EAC9C;AAAA,EAEA,MAAM,UAAU,YAA6C;AAC3D,UAAM,MAAuB,WAAW,IAAI,CAAC,EAAE,KAAK,KAAK,MAAM;AAAA,MAC7D;AAAA,MACC,QAAQ,CAAC;AAAA,IACZ,CAAC;AAED,UAAM,SAAS,MAAM,KAAK,GAAG,kBAAkB,GAAG;AAElD,WAAO,EAAE,cAAc,OAAO,aAAc;AAAA,EAC9C;AACF;AAEA,SAAS,aAAa,KAA0B;AAC9C,QAAM,YAAiC,CAAC;AACxC,aAAW,OAAO,KAAK;AACrB,cAAU,GAAG,IAAI,IAAI,GAAG;AAAA,EAC1B;AACA,SAAO;AACT;","names":[]}